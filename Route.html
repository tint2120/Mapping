
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Route Planner with GPX & Mapbox API</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html, body { margin:0; height:100%; width:100vw; overflow:hidden; font-family:sans-serif; }
#map { position:absolute; top:0; left:0; right:0; bottom:0; }

#sidebar {
  position: fixed;
  top: 0;
  right: 0;
  width: 360px;
  height: 100vh; 
  background: #f9f9f9;
  border-left: 1px solid #ccc;
  padding: 10px;
  box-sizing: border-box;
  z-index: 1000;
  transition: transform 0.3s ease;
  overflow-y: auto;
}

#sidebar.collapsed { transform: translateX(100%); }

#sidebarToggle {
  width:36px; height:54px; 
  background:#007bff; color:#fff;
  font-size:22px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; border-radius:6px 0 0 6px; z-index:6000;
  
  position: fixed;
  right: 360px;
  top: 50%; 
  transform: translateY(-50%);
  transition: right 0.3s ease;
}

#sidebar.collapsed + #sidebarToggle {
  right: 0;
}

#tableContainer {
  border: 1px solid #ccc;
  margin-top: 10px;
  height: auto;
  max-height: none;
  overflow: visible;
}

#stopsTable { width:100%; border-collapse:collapse; font-size:12px; }
#stopsTable th, #stopsTable td { padding:3px 4px; border:1px solid #ccc; }
#stopsTable thead th { position: sticky; top:0; background:#f1f1f1; z-index:1; }

.drag-handle { cursor:grab; text-align:center; width:20px; font-weight:bold; }
.marker-label { color:#fff; border-radius:50%; width:24px; height:24px;
  line-height:24px; text-align:center; font-weight:bold;
  border:2px solid white; box-shadow:0 0 2px rgba(0,0,0,0.5);}
</style>
</head>
<body>
<div id="map"></div>

<aside id="sidebar">
  <div style="display:flex; gap:6px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
    <button onclick="clearStops()">Clear (keep Start/End)</button>
    <button onclick="exportGPX()">Export GPX</button>
    <button onclick="deleteSelectedStops()">Delete Selected</button>
    
    <label for="importFile" style="background:#007bff;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;">Choose GPX file(s)</label>
    <input type="file" id="importFile" accept=".gpx" multiple style="display:none;" onchange="importGPX(event)">
    <span id="fileLabel" style="font-size:12px; color:#555;"></span>
  </div>

  <button id="toggleLocation" style="margin-bottom:10px;">Enable Current Location</button>

  <div id="tableContainer">
    <table id="stopsTable">
      <thead><tr><th>#</th><th>Name</th><th>Delete?</th></tr></thead>
      <tbody id="stopsBody"></tbody>
    </table>
  </div>

  <div id="routeInfo" style="margin-top:10px;"></div>
</aside>

<div id="sidebarToggle">&#x25C0;</div> <!-- always-visible toggle button -->

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
const WORK_START = { name:"Start", lat:54.971630, lon:-2.949631 };
const WORK_STOP  = { name:"End", lat:54.971653, lon:-2.949319 };
const DEFAULT_CENTER = [54.58303,-2.56954];
const DEFAULT_ZOOM = 6;
const MAPBOX_TOKEN = 'pk.eyJ1Ijoibmlja2llc2hpbGwiLCJhIjoiY21meTl6cGszMGpqZDJrc2htOXQ3d2s0OSJ9.Yg8NuZbRwGovAt4AWHWxMQ';

const map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19 }).addTo(map);

let stops = [WORK_START, WORK_STOP];
let markers = [];
let routeLine = null;
const stopsBody = document.getElementById("stopsBody");
const routeInfoEl = document.getElementById("routeInfo");
let sortable = null;

// Table & markers
function updateStopsTable(){
  stopsBody.innerHTML = stops.map((s,i)=>{
    const locked = (i===0 || i===stops.length-1);
    return `<tr data-index="${i}">
      <td class="drag-handle" ${locked ? '' : `title="Drag stop #${i+1}"`}>${i+1}</td>
      <td>${s.name}${locked?" (fixed)":""}</td>
      <td>${locked?"":'<input type="checkbox" class="deleteChk"/>'}</td>
    </tr>`;
  }).join("");
  stopsBody.innerHTML += `<tr><td colspan="3" style="text-align:center;color:#888;">(empty)</td></tr>`;
  refreshMarkers();
  initSortable();
}

function refreshMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
  stops.forEach((s,i)=>{
    let color="rgba(0,123,255,0.7)";
    let popupName=s.name;
    if(i===0){ color="green"; popupName="Start"; }
    else if(i===stops.length-1){ color="red"; popupName="End"; }
    const icon = L.divIcon({className:'', html:`<div class="marker-label" style="background:${color}">${i+1}</div>`, iconSize:[30,30], iconAnchor:[15,15]});
    markers.push(L.marker([s.lat,s.lon],{icon}).addTo(map).bindPopup(`${popupName} (#${i+1})`));
  });
}

// Draggable table
function initSortable(){
  if(sortable){ try{sortable.destroy();}catch(e){} }
  sortable = Sortable.create(stopsBody, {
    handle: '.drag-handle',
    animation: 150,
    filter: 'tr:first-child,tr:last-child',
    onEnd: function() {
      const newStops = [];
      stopsBody.querySelectorAll('tr[data-index]').forEach(row=>{
        newStops.push(stops[parseInt(row.dataset.index)]);
      });
      stops = [WORK_START, ...newStops.slice(1,-1), WORK_STOP];
      updateStopsTable();
      calculateRoute();
    }
  });
}

// Clear stops
function clearStops(){ stops=[WORK_START,WORK_STOP]; if(routeLine){ map.removeLayer(routeLine); routeLine=null;} updateStopsTable(); routeInfoEl.textContent=""; }

// Delete selected
function deleteSelectedStops(){
  const checkboxes=stopsBody.querySelectorAll(".deleteChk:checked");
  if(!checkboxes.length) return;
  const indices=Array.from(checkboxes).map(cb=>parseInt(cb.closest("tr").dataset.index));
  stops = stops.filter((_,i)=>!indices.includes(i));
  updateStopsTable(); calculateRoute();
}

// Export GPX (only non-start/end)
function exportGPX(){
  if(stops.length<=2) return alert("No stops to export");
  let gpx='<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="LeafletRouteApp" xmlns="http://www.topografix.com/GPX/1/1">\n';
  stops.slice(1,-1).forEach(s=>{ gpx+=`<wpt lat="${s.lat}" lon="${s.lon}"><name>${s.name}</name></wpt>\n`; });
  gpx+='</gpx>';
  const blob=new Blob([gpx],{type:"application/gpx+xml"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="stops.gpx"; a.click(); URL.revokeObjectURL(url);
}

// GPX import
function importGPX(event){
  const files = event.target.files;
  const fileLabel = document.getElementById("fileLabel");
  fileLabel.textContent = files.length ? Array.from(files).map(f=>f.name).join(', ') : '';
  if(!files || files.length===0) return;

  Array.from(files).forEach(file=>{
    const reader = new FileReader();
    reader.onload = e=>{
      try {
        const xml = new DOMParser().parseFromString(e.target.result,"text/xml");
        const wpts = xml.getElementsByTagName("wpt");
        const newStops = [];
        for(let i=0;i<wpts.length;i++){
          const wpt = wpts[i];
          const lat=parseFloat(wpt.getAttribute("lat"));
          const lon=parseFloat(wpt.getAttribute("lon"));
          const nameEl = wpt.getElementsByTagName("name")[0];
          const name = nameEl ? nameEl.textContent : "Waypoint";
          newStops.push({lat, lon, name});
        }

        stops = [stops[0], ...stops.slice(1,-1), ...newStops, stops[stops.length-1]];
      } catch(err){ alert("Failed to import GPX: "+err.message); }
      updateStopsTable();
      setTimeout(calculateRoute, 200);
    };
    reader.readAsText(file);
  });
  event.target.value="";
}

// Mapbox routing
async function calculateRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null;}
  if(stops.length<2) return;

  const coords = stops.map(s=>`${s.lon},${s.lat}`).join(';');
  const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&overview=full&access_token=${MAPBOX_TOKEN}`;

  try{
    const resp = await fetch(url);
    const data = await resp.json();
    if(!data.routes || !data.routes[0]) return;

    const geo = data.routes[0].geometry;
    routeLine = L.geoJSON(geo, {color:'#00008B', weight:4, opacity:1}).addTo(map);

    const distKm=(data.routes[0].distance/1000).toFixed(1);
    const distMi=(data.routes[0].distance/1609.34).toFixed(1);
    const totalSec = data.routes[0].duration;
    const hours=Math.floor(totalSec/3600);
    const mins=Math.round((totalSec%3600)/60);
    routeInfoEl.textContent=`Total distance: ${distKm} km (${distMi} mi), Estimated time: ${hours}h ${mins}m`;
  }catch(err){ console.error(err); }
}

// Sidebar toggle
document.getElementById("sidebarToggle").addEventListener("click", ()=>{
  const sidebar = document.getElementById("sidebar");
  sidebar.classList.toggle("collapsed");
  const toggleBtn = document.getElementById("sidebarToggle");
  toggleBtn.innerHTML = sidebar.classList.contains("collapsed")?'&#x25C0;':'&#x25B6;';
  setTimeout(()=>map.invalidateSize(), 300);
});

// Current location
let locationMarker=null;
let locationWatchId=null;
document.getElementById("toggleLocation").addEventListener("click",()=>{
  const btn=document.getElementById("toggleLocation");
  if(locationWatchId){
    navigator.geolocation.clearWatch(locationWatchId);
    locationWatchId=null;
    if(locationMarker){ map.removeLayer(locationMarker); locationMarker=null;}
    btn.textContent="Enable Current Location";
  } else {
    locationWatchId=navigator.geolocation.watchPosition(pos=>{
      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      if(locationMarker) locationMarker.setLatLng([lat,lon]);
      else{
        const icon=L.divIcon({className:'', html:`<div style="width:20px;height:20px;background:red;border-radius:50%"></div>`, iconSize:[20,20], iconAnchor:[10,10]});
        locationMarker=L.marker([lat,lon],{icon}).addTo(map);
      }
    }, err=>console.warn(err), {enableHighAccuracy:true});
    btn.textContent="Disable Current Location";
  }
});

// Double-click add stop
map.on("dblclick", e=>{
  const lat=e.latlng.lat, lon=e.latlng.lng;
  const name="Stop "+(stops.length-1);
  stops.splice(stops.length-1,0,{lat,lon,name});
  updateStopsTable();
  calculateRoute();
});

// Init
updateStopsTable();
calculateRoute();
</script>
</body>
</html>
