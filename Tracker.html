<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mobile Geolocation GPX</title>
<style>
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: url("gb.svg") center/cover no-repeat, #f0f0f0;
    margin: 0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    padding: 30px 20px;
    text-align: center;
    width: min(90%, 400px);
    backdrop-filter: blur(6px);
  }
  h1 { margin-bottom: 10px; font-size: 1.8em; }
  #demo { margin-top: 20px; font-size: 20px; font-weight: bold; color: #222; min-height: 60px; word-wrap: break-word; }
  .btn-container { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
  button {
    flex: 1; min-width: 120px; padding: 12px 18px; font-size: 16px;
    border: none; border-radius: 12px; color: white;
    background: linear-gradient(135deg, #007bff, #0056b3);
    cursor: pointer; transition: transform 0.2s ease, background 0.3s;
  }
  button:hover { background: linear-gradient(135deg, #0056b3, #003f7f); transform: translateY(-2px); }
  button:disabled { background: #999; cursor: not-allowed; transform: none; }
</style>
</head>
<body>

<div class="card">
  <h1>üìç Mobile Geolocation</h1>
  <p>Your coordinates will be recorded to GPX:</p>
  <div class="btn-container">
    <button id="stopBtn">‚èπ Stop</button>
    <button id="downloadBtn" disabled>‚¨á Download GPX</button>
  </div>
  <p id="demo" role="status" aria-live="polite">Initializing GPS‚Ä¶</p>
</div>

<script>
const x = document.getElementById("demo");
const stopBtn = document.getElementById("stopBtn");
const downloadBtn = document.getElementById("downloadBtn");

let watchId = null;
let gpxPoints = [];
let wakeLock = null;
let wakeLockTimer = null;
let lastRecordTime = null;

// Wake lock to keep screen awake, re-request every 5 minutes
async function enableWakeLock() {
  try {
    if (wakeLock) {
      await wakeLock.release();
      wakeLock = null;
    }
    wakeLock = await navigator.wakeLock?.request("screen");
    if (wakeLock) wakeLock.addEventListener('release', () => console.log('Screen unlocked'));
    // Setup periodic re-request every 5 minutes
    if (wakeLockTimer) clearInterval(wakeLockTimer);
    wakeLockTimer = setInterval(enableWakeLock, 5 * 60 * 1000); // 5 minutes
  } catch (err) {
    console.warn("Wake Lock not supported:", err);
  }
}
function disableWakeLock() {
  if (wakeLockTimer) {
    clearInterval(wakeLockTimer);
    wakeLockTimer = null;
  }
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}

// Start tracking automatically on load
function startTracking() {
  if (!navigator.geolocation) {
    x.textContent = "‚ùå Geolocation not supported.";
    return;
  }
  if (watchId !== null) return;

  watchId = navigator.geolocation.watchPosition(success, error, {
    enableHighAccuracy: true,
    maximumAge: 5000,
    timeout: 10000
  });

  gpxPoints = [];
  downloadBtn.disabled = true;
  x.textContent = "Recording GPS points‚Ä¶";
  lastRecordTime = null;

  enableWakeLock();
}

// Stop tracking
stopBtn.addEventListener("click", () => {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    disableWakeLock();
    downloadBtn.disabled = gpxPoints.length === 0;
    x.textContent = `Tracking stopped. ${gpxPoints.length} points recorded.`;
  }
});

// Download GPX with timestamp in filename
downloadBtn.addEventListener("click", () => {
  if (gpxPoints.length === 0) return;

  const gpxHeader = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="MobileGeolocation" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>GPS Track</name><trkseg>`;
  const gpxFooter = `</trkseg></trk></gpx>`;
  const gpxBody = gpxPoints.map(p => 
    `<trkpt lat="${p.lat}" lon="${p.lon}"><time>${new Date(p.time).toISOString()}</time></trkpt>`
  ).join("\n");
  const gpxContent = gpxHeader + "\n" + gpxBody + "\n" + gpxFooter;

  const now = new Date();
  const pad = n => n.toString().padStart(2, '0');
  const timestamp = `${now.getFullYear().toString().slice(2)}-${pad(now.getMonth()+1)}-${pad(now.getDate())}-${pad(now.getHours())}-${pad(now.getMinutes())}`;

  const blob = new Blob([gpxContent], { type: "application/gpx+xml" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `track-${timestamp}.gpx`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  x.textContent = `GPX file downloaded: track-${timestamp}.gpx`;
});

// Success callback
function success(pos) {
  const lat = pos.coords.latitude.toFixed(6);
  const lon = pos.coords.longitude.toFixed(6);
  const acc = pos.coords.accuracy.toFixed(1);
  const time = pos.timestamp;

  // Speed in m/s, convert to km/h
  const speed = pos.coords.speed !== null ? pos.coords.speed * 3.6 : null; // m/s to km/h

  // Decide interval based on speed
  let interval = 3 * 1000; // Default 3 seconds
  if (speed !== null) {
    if (speed >= 80) {
      interval = 20 * 1000;
    } else if (speed >= 30) {
      interval = 10 * 1000;
    } else if (speed >= 3) {
      interval = 3 * 1000;
    }
    // else: below 3km/h, keep 3s
  }

  // Record only if enough time has passed
  if (
    !lastRecordTime || 
    (time - lastRecordTime) >= interval
  ) {
    gpxPoints.push({lat, lon, time});
    lastRecordTime = time;
  }

  x.innerHTML = `Last point: ${lat}, ${lon}<br>Accuracy: ¬±${acc}m<br>Speed: ${speed !== null ? speed.toFixed(1) : 'N/A'} km/h<br>Points recorded: ${gpxPoints.length}`;
}

// Error callback
function error(err) {
  const messages = {
    1: "‚ùå User denied Geolocation.",
    2: "‚ö†Ô∏è Location unavailable.",
    3: "‚è≥ Geolocation timed out."
  };
  x.textContent = messages[err.code] || "‚ùì Unknown error.";
}

// Auto-start tracking when page loads
window.addEventListener("load", startTracking);
window.addEventListener("beforeunload", disableWakeLock);
</script>

</body>
</html>