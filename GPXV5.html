<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lat/Lon ‚Üí GPX</title>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f8fafc;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: start;
  min-height: 100vh;
  margin: 0;
  padding: 30px;
}
.box {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
  padding: 20px 30px;
  width: 420px;
  text-align: center;
}
h2 {
  margin-bottom: 15px;
}
input {
  width: 200px;
  padding: 8px;
  margin: 6px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
  text-align: center;
}
button {
  margin: 6px;
  padding: 8px 18px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #0078ff;
  color: white;
  transition: 0.2s;
}
button:hover {
  background: #005fcc;
}
table {
  margin-top: 15px;
  width: 100%;
  border-collapse: collapse;
}
th,
td {
  border-bottom: 1px solid #eee;
  padding: 6px 4px;
  text-align: center;
}
th {
  background: #f3f4f6;
}
td {
  font-size: 14px;
}
.deleteBtn {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 16px;
}
</style>
</head>
<body>

<div class="box">
<h2>Lat/Lon ‚Üí GPX</h2>

<!-- Manual add section -->
<input type="text" id="name" placeholder="Name (optional)">
<input type="text" id="lat" placeholder="Latitude">
<input type="text" id="lon" placeholder="Longitude"><br>
<button id="addBtn">Add Point</button>
<button id="importBtn">Import GPX</button>
<button id="exportBtn">Export GPX</button>
<button id="clearBtn" style="background:#ef4444;">Clear</button>
<input type="file" id="fileInput" accept=".gpx" style="display:none">

<hr style="margin:15px 0">

<!-- Search section -->
<input type="text" id="searchBox" placeholder="Enter postcode (e.g. CA8 1NY)" style="width:250px;"><br>
<input type="text" id="customerBox" placeholder="Enter customer name" style="width:250px;"><br>
<button id="searchBtn" style="background:#10b981;">Search</button>

<hr style="margin:15px 0">

<!-- File loaders -->
<button id="loadPostcodeBtn" style="background:#f59e0b;">Load Postcode File</button>
<button id="loadCustomerBtn" style="background:#9333ea;">Load Customer File</button>
<input type="file" id="postcodeFileInput" accept=".csv,.txt" style="display:none">
<input type="file" id="customerFileInput" accept=".csv,.txt" style="display:none">

<table id="pointsTable">
<thead>
<tr><th>#</th><th>Name</th><th>Lat</th><th>Lon</th><th>Delete</th></tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
let points = [];
let postcodeFileContent = localStorage.getItem("postcodeFile") || "";
let customerFileContent = localStorage.getItem("customerFile") || "";

// --- Add manually
document.getElementById("addBtn").addEventListener("click", () => {
  const name = document.getElementById("name").value.trim() || "Unnamed";
  const lat = parseFloat(document.getElementById("lat").value.trim());
  const lon = parseFloat(document.getElementById("lon").value.trim());
  if (isNaN(lat) || isNaN(lon)) return alert("Please enter valid latitude and longitude.");
  points.push({ name, lat, lon });
  updateTable();
  clearInputs();
});

// --- Update table
function updateTable() {
  const tbody = document.querySelector("#pointsTable tbody");
  tbody.innerHTML = points.map((p, i) => `
    <tr>
      <td>${i + 1}</td>
      <td>${p.name}</td>
      <td>${p.lat.toFixed(6)}</td>
      <td>${p.lon.toFixed(6)}</td>
      <td><button class="deleteBtn" onclick="deleteRow(${i})">üóëÔ∏è</button></td>
    </tr>
  `).join("");
}

// --- Delete row
function deleteRow(index) {
  points.splice(index, 1);
  updateTable();
}

// --- Clear inputs
function clearInputs() {
  document.getElementById("lat").value = "";
  document.getElementById("lon").value = "";
  document.getElementById("name").value = "";
  document.getElementById("customerBox").value = "";
  document.getElementById("searchBox").value = "";
}

// --- Export GPX
document.getElementById("exportBtn").addEventListener("click", () => {
  if (points.length === 0) return alert("No points to export.");
  let gpx = `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="LatLonToGPX" xmlns="http://www.topografix.com/GPX/1/1">\n`;
  points.forEach((p) => {
    gpx += `  <wpt lat="${p.lat.toFixed(6)}" lon="${p.lon.toFixed(6)}"><name>${p.name}</name></wpt>\n`;
  });
  gpx += "</gpx>";
  const blob = new Blob([gpx], { type: "application/gpx+xml" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "points.gpx";
  a.click();
  URL.revokeObjectURL(a.href);
});

// --- Import GPX
document.getElementById("importBtn").addEventListener("click", () => document.getElementById("fileInput").click());
document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = event => {
    const xml = new DOMParser().parseFromString(event.target.result, "application/xml");
    const wpts = xml.getElementsByTagName("wpt");
    points = [];
    for (let i = 0; i < wpts.length; i++) {
      const lat = parseFloat(wpts[i].getAttribute("lat"));
      const lon = parseFloat(wpts[i].getAttribute("lon"));
      const name = wpts[i].getElementsByTagName("name")[0]?.textContent || (i + 1).toString();
      if (!isNaN(lat) && !isNaN(lon)) points.push({ name, lat, lon });
    }
    updateTable(); e.target.value = "";
  };
  reader.readAsText(file);
});

// --- Clear all
document.getElementById("clearBtn").addEventListener("click", () => { points = []; updateTable(); });

// --- Load postcode file
document.getElementById("loadPostcodeBtn").addEventListener("click", () => {
  document.getElementById("postcodeFileInput").click();
});
document.getElementById("postcodeFileInput").addEventListener("change", e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    postcodeFileContent = ev.target.result;
    localStorage.setItem("postcodeFile", postcodeFileContent);
    alert("‚úÖ Postcode file loaded!");
  };
  reader.readAsText(file);
});

// --- Load customer file
document.getElementById("loadCustomerBtn").addEventListener("click", () => {
  document.getElementById("customerFileInput").click();
});
document.getElementById("customerFileInput").addEventListener("change", e => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    customerFileContent = ev.target.result;
    localStorage.setItem("customerFile", customerFileContent);
    alert("‚úÖ Customer file loaded!");
  };
  reader.readAsText(file);
});

// --- Search button
document.getElementById("searchBtn").addEventListener("click", () => {
  const postcodeTerm = document.getElementById("searchBox").value.trim();
  const customerTerm = document.getElementById("customerBox").value.trim();

  if (customerTerm && customerFileContent) {
    searchCustomer(customerFileContent, customerTerm);
  } else if (postcodeTerm && postcodeFileContent) {
    searchPostcode(postcodeFileContent, postcodeTerm);
  } else {
    alert("Please enter a postcode or customer name, and ensure the matching file is loaded.");
  }
});

// --- Search customer file
function searchCustomer(content, term) {
  const lines = content.split(/\r?\n/);
  let found = false;
  for (let line of lines) {
    if (line.toUpperCase().includes(term.toUpperCase())) {
      const parts = line.split(",");
      if (parts.length >= 3) {
        const name = parts[0];
        const lat = parseFloat(parts[1]);
        const lon = parseFloat(parts[2]);
        if (!isNaN(lat) && !isNaN(lon)) {
          points.push({ name, lat, lon });
          updateTable();
          found = true;
          break;
        }
      }
    }
  }
  if (!found) alert(`"${term}" not found in customer file.`);
  clearInputs();
}

// --- Search postcode file
function searchPostcode(content, term) {
  const lines = content.split(/\r?\n/);
  let found = false;
  for (let line of lines) {
    if (line.toUpperCase().includes(term.toUpperCase())) {
      const parts = line.split(",");
      if (parts.length >= 4) {
        const lat = parseFloat(parts[2]);
        const lon = parseFloat(parts[3]);
        if (!isNaN(lat) && !isNaN(lon)) {
          const name = parts[0].replace(/"/g, "") || (points.length + 1).toString();
          points.push({ name, lat, lon });
          updateTable();
          found = true;
          break;
        }
      }
    }
  }
  if (!found) alert(`"${term}" not found in postcode file.`);
  clearInputs();
}
</script>

</body>
</html>
