<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lat/Lon → GPX</title>
<link rel="manifest" href="manifest.json">
<style>
body { font-family: system-ui,sans-serif; background:#f8fafc; display:flex; flex-direction:column; align-items:center; justify-content:start; min-height:100vh; margin:0; padding:30px; }
.box { background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.05); padding:20px 30px; width:400px; text-align:center; }
h2{margin-bottom:15px;} input{width:140px;padding:8px;margin:6px;border:1px solid #ccc;border-radius:6px;font-size:15px;text-align:center;}
button{margin:6px;padding:8px 18px;font-size:15px;border:none;border-radius:6px;cursor:pointer;background:#0078ff;color:white;transition:0.2s;} button:hover{background:#005fcc;}
table{margin-top:15px;width:100%;border-collapse:collapse;} th,td{border-bottom:1px solid #eee;padding:6px 4px;} th{background:#f3f4f6;} td{font-size:14px;}
</style>
</head>
<body>

<div class="box">
<h2>Lat/Lon → GPX</h2>
<input type="text" id="lat" placeholder="Latitude">
<input type="text" id="lon" placeholder="Longitude"><br>

<button id="addBtn">Add Point</button>
<button id="importBtn">Import GPX</button>
<button id="exportBtn">Export GPX</button>
<button id="clearBtn" style="background:#ef4444;">Clear</button>
<input type="file" id="fileInput" accept=".gpx" style="display:none">

<hr style="margin:15px 0">

<input type="text" id="searchBox" placeholder="Enter postcode (e.g. CA8 1NY)" style="width:250px;">
<button id="searchBtn" style="background:#10b981;">Search</button>
<button id="loadFileBtn" style="background:#f59e0b;">Load Search File</button>
<input type="file" id="searchFileInput" accept=".txt,.csv" style="display:none">

<table id="pointsTable">
<thead><tr><th>#</th><th>Lat</th><th>Lon</th></tr></thead>
<tbody></tbody>
</table>
</div>

<script>
let points=[], lastFileContent = localStorage.getItem("lastSearchFileContent") || "";

// --- Add manually
document.getElementById("addBtn").addEventListener("click", ()=>{
  const lat=parseFloat(document.getElementById("lat").value.trim());
  const lon=parseFloat(document.getElementById("lon").value.trim());
  if(isNaN(lat)||isNaN(lon)) return alert("Please enter valid numbers.");
  points.push({lat,lon}); updateTable();
  document.getElementById("lat").value=""; document.getElementById("lon").value="";
});

// --- Update table
function updateTable(){
  const tbody=document.querySelector("#pointsTable tbody");
  tbody.innerHTML = points.map((p,i)=>`<tr><td>${i+1}</td><td>${p.lat.toFixed(6)}</td><td>${p.lon.toFixed(6)}</td></tr>`).join("");
}

// --- Export GPX
document.getElementById("exportBtn").addEventListener("click", ()=>{
  if(points.length===0) return alert("No points to export.");
  let gpx=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="LatLonToGPX" xmlns="http://www.topografix.com/GPX/1/1">\n`;
  points.forEach((p,i)=>{gpx+=`  <wpt lat="${p.lat.toFixed(6)}" lon="${p.lon.toFixed(6)}"><name>${i+1}</name></wpt>\n`;});
  gpx+="</gpx>";
  const blob=new Blob([gpx],{type:"application/gpx+xml"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="points.gpx"; a.click(); URL.revokeObjectURL(a.href);
});

// --- Import GPX
document.getElementById("importBtn").addEventListener("click", ()=>document.getElementById("fileInput").click());
document.getElementById("fileInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=event=>{
    const xml=new DOMParser().parseFromString(event.target.result,"application/xml");
    const wpts=xml.getElementsByTagName("wpt"), trkpts=xml.getElementsByTagName("trkpt");
    points=[];
    if(wpts.length>0){for(let i=0;i<wpts.length;i++){const lat=parseFloat(wpts[i].getAttribute("lat")); const lon=parseFloat(wpts[i].getAttribute("lon")); if(!isNaN(lat)&&!isNaN(lon)) points.push({lat,lon});}}
    else if(trkpts.length>0){for(let i=0;i<trkpts.length;i++){const lat=parseFloat(trkpts[i].getAttribute("lat")); const lon=parseFloat(trkpts[i].getAttribute("lon")); if(!isNaN(lat)&&!isNaN(lon)) points.push({lat,lon});}}
    updateTable(); e.target.value="";
  };
  reader.readAsText(file);
});

// --- Clear without confirmation
document.getElementById("clearBtn").addEventListener("click", ()=>{ points=[]; updateTable(); });

// --- Load search file manually
document.getElementById("loadFileBtn").addEventListener("click", ()=>document.getElementById("searchFileInput").click());
document.getElementById("searchFileInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=event=>{
    lastFileContent = event.target.result;
    localStorage.setItem("lastSearchFileContent", lastFileContent);
    e.target.value="";
    alert("Search file loaded successfully!");
  };
  reader.readAsText(file);
});

// --- Search with automatic add
document.getElementById("searchBtn").addEventListener("click", ()=>{
  const searchTerm=document.getElementById("searchBox").value.trim().toUpperCase();
  if(!searchTerm) return alert("Enter postcode to search.");
  if(lastFileContent){ searchInContent(lastFileContent, searchTerm); }
  else{ alert("Please load a search file first."); }
});

function searchInContent(content, term){
  const lines=content.split(/\r?\n/); let found=false;
  for(let line of lines){
    if(line.toUpperCase().includes(term)){
      const parts=line.split(",");
      if(parts.length>=4){
        const lat=parseFloat(parts[2]); const lon=parseFloat(parts[3]);
        if(!isNaN(lat)&&!isNaN(lon)){
          document.getElementById("lat").value=lat;
          document.getElementById("lon").value=lon;
          points.push({lat,lon}); updateTable(); found=true; break;
        }
      }
    }
  }
  if(!found) alert(`"${term}" not found in loaded file.`);
}

// --- Service Worker for offline caching
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').then(()=>console.log("SW registered")).catch(err=>console.log("SW fail",err)); }

</script>
</body>
</html>
